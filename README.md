# Apollo Vehicles API

A CRUD-style web service for managing vehicle records, built with FastAPI and PostgreSQL.

## Quick Links

- [Local Setup](#setup)
- [Running Tests](#running-tests)
- [API Documentation](#api-endpoints)
- [AWS Deployment Guide](./DEPLOYMENT.md)

## Prerequisites

- Python 3.14+ (or 3.10+)
- PostgreSQL 12+ (or Docker for containerized setup)

## Setup

### Option 1: Local PostgreSQL Setup

NOTE: The PostgreSQL table has a user and password, this was implemented for an extra layer of security in actual production settings.

1. **Install dependencies:**
   ```bash
   pip install -r requirements.txt
   ```

2. **Set up PostgreSQL database:**
   ```bash
   # Create database and user
   psql -U postgres
   ```
   ```sql
   CREATE DATABASE vehicles_db;
   CREATE USER vehicles_user WITH PASSWORD 'apollo';
   GRANT ALL PRIVILEGES ON DATABASE vehicles_db TO vehicles_user;
   \q
   ```

3. **Create `.env` file:**

NOTE: for the purpose of this project, we store the password in
env so we don't expose it in the actual code

   ```
   CONN_URL=postgresql://vehicles_user:apollo@localhost:5432/vehicles_db
   ```

4. **Run the application:**
   ```bash
   uvicorn app.main:app --reload
   ```

   SwaggerUI API: `http://localhost:8000`
   ReDoc: `http://localhost:8000/redoc`
   These APIs are autogenerated by FastAPI

### Option 2: Docker Setup (Optional)

**Prerequisites:** Docker Desktop must be running.

1. **Start PostgreSQL:**
   ```bash
   docker-compose up -d
   ```
   
   This will:
   - Pull the PostgreSQL 15 image (if not already present)
   - Create a container named `apollo_vehicles_db`
   - Set up the database, user, and password automatically
   - Expose PostgreSQL on port 5432

2. **Verify it's running:**
   ```bash
   docker ps
   ```
   You should see `apollo_vehicles_db` in the list.

3. **Create `.env` file:**
   ```bash
   echo "CONN_URL=postgresql://vehicles_user:apollo@localhost:5432/vehicles_db" > .env
   ```

4. **Install dependencies and run:**
   ```bash
   pip install -r requirements.txt
   uvicorn app.main:app --reload
   ```

  SwaggerUI API: `http://localhost:8000`
  
  ReDoc: `http://localhost:8000/redoc`
  
  These APIs are autogenerated by FastAPI

**Note:** If port 5432 is already in use by a local PostgreSQL instance, you can modify `docker-compose.yml` to use a different port (e.g., `"5433:5432"`) and update the `.env` file accordingly.

**Stop Docker container:**
```bash
docker-compose down
```

**Stop and remove all data:**
```bash
docker-compose down -v
```

## Running Tests

- Tests use a separate `vehicles_test` table to avoid affecting production data.
- PostgreSQL database must be running  v
- For Docker: Ensure `docker-compose up -d` has been run and container is running
- `.env` file must be configured with `CONN_URL` pointing to your database - For Docker: Ensure `docker-compose up -d` has been run and container is running

```bash
# run all tests
pytest tests/

# run with verbose output
pytest tests/ -v

# run specific test file
pytest tests/test_vehicles.py
```

## API Endpoints

| Method | Endpoint | Description | Status Code |
|--------|----------|-------------|-------------|
| GET | `/vehicle` | List all vehicles | 200 OK |
| POST | `/vehicle` | Create new vehicle | 201 Created |
| GET | `/vehicle/{vin}` | Get vehicle by VIN | 200 OK |
| PUT | `/vehicle/{vin}` | Update vehicle (full replacement) | 200 OK |
| DELETE | `/vehicle/{vin}` | Delete vehicle | 204 No Content |

## Error Handling

- **400 Bad Request:** Cannot parse request entity as JSON
- **422 Unprocessable Entity:** Valid JSON but invalid attributes (missing fields, validation failures, duplicate VIN)
- **404 Not Found:** Vehicle with specified VIN not found

## Database Schema

The `vehicles` table includes:

- `vin` (String(17), Primary Key) - Case-insensitive, unique
- `manufacturer_name` (String(50), Required)
- `description` (Text, Optional)
- `horse_power` (Integer, Required)
- `model_name` (String(100), Required)
- `model_year` (Integer, Required)
- `purchase_price` (Numeric(12,2), Required)
- `fuel_type` (String(50), Required)

## Project Structure

```txt
.
├── app/
│   ├── __init__.py
│   ├── main.py           # FastAPI application
│   ├── database.py       # Database connection
│   ├── models.py         # SQLAlchemy models
│   ├── schemas.py        # Pydantic schemas
│   ├── crud.py           # Database operations
│   └── routers/
│       └── vehicles.py   # API endpoints
├── tests/
│   ├── test_vehicles.py  # API endpoint tests
│   ├── test_crud.py      # CRUD function tests
│   ├── test_db.py        # Database schema tests
│   └── conftest.py       # Test fixtures
├── requirements.txt
├── pytest.ini
└── README.md
```

## Development

The application uses:

- **FastAPI** for the web framework
- **SQLAlchemy** for ORM
- **Pydantic** for data validation
- **PostgreSQL** for the database
- **pytest** for testing

## Notes

- VINs are stored in lowercase for case-insensitive uniqueness
- VIN length must be between 5-17 characters (supports old and modern VIN formats)
- PUT operations perform full replacement (all fields required)
- Tests use a separate `vehicles_test` table to protect production data. Ideally, we would have a sandbox database for tests
